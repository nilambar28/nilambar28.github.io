<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCC Test (Q66-92)</title>
    <style>
        :root {
            --primary: #e91e63;
            --primary-dark: #c2185b;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --correct: #4caf50;
            --wrong: #f44336;
            --review: #9c27b0;
            --blue-current: #2196f3;
            --skipped: #9e9e9e;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); color: var(--text-color); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- SCREENS --- */
        .screen { display: none; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* --- HOME SCREEN --- */
        #home-screen { align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .app-logo { font-size: 50px; margin-bottom: 20px; }
        .stats-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 350px; margin-bottom: 20px; text-align: left; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .btn-large { background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; max-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); margin-top: 15px; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-large:active { transform: scale(0.98); }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); margin-top: 15px; }

        /* --- HEADER --- */
        header { background: var(--primary); color: white; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; flex-shrink: 0; }
        .timer { font-weight: bold; font-size: 18px; font-family: monospace; background: rgba(0,0,0,0.1); padding: 5px 10px; border-radius: 4px; }
        .header-icons { display: flex; gap: 20px; align-items: center; }
        .header-icon { cursor: pointer; font-size: 20px; font-weight: bold; display: flex; align-items: center; justify-content: center; width: 35px; height: 35px; border-radius: 50%; transition: background 0.2s; }
        .header-icon:active { background: rgba(255,255,255,0.2); }
        
        /* --- MAIN TEST AREA --- */
        #quiz-container { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; position: relative; background: #f0f2f5; }
        .question-card { background: var(--card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .q-meta { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .q-tag { background: #e3f2fd; color: #1565c0; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .q-text { font-size: 16px; font-weight: 500; margin-bottom: 20px; line-height: 1.5; color: #000; }
        
        .options { list-style: none; padding: 0; }
        .option { padding: 14px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s; background: #fff; }
        .option-circle { height: 22px; width: 22px; border: 2px solid #ccc; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 12px; font-weight: bold; color: white; }
        
        /* Interaction States */
        .option.selected { border-color: var(--blue-current); background: #e3f2fd; }
        .option.correct { border-color: var(--correct); background: #e8f5e9; }
        .option.wrong { border-color: var(--wrong); background: #ffebee; }
        
        .option.correct .option-circle { border-color: var(--correct); background: var(--correct); content: "‚úì"; }
        .option.wrong .option-circle { border-color: var(--wrong); background: var(--wrong); content: "‚úï"; }

        /* --- SOLUTION BOX --- */
        .solution-box { display: none; margin-top: 20px; background: #f8f9fa; padding: 15px; border-left: 4px solid var(--primary); border-radius: 4px; font-size: 14px; color: #444; line-height: 1.5; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .solution-header { font-weight: bold; color: var(--primary); margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }

        /* --- FOOTER --- */
        footer { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; height: 60px; z-index: 10; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .nav-btn { background: white; border: 1px solid #ccc; padding: 8px 18px; border-radius: 20px; font-weight: bold; color: #555; cursor: pointer; font-size: 14px; }
        .nav-btn.primary { background: var(--primary); color: white; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .center-actions { display: flex; gap: 20px; }
        .icon-btn { font-size: 24px; padding: 0; border: none; background: none; color: #757575; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; }
        .icon-btn:active { background: #eee; }
        .icon-btn.active-review { color: var(--review); }
        .icon-btn.active-bookmark { color: #ff9800; }

        /* --- PALETTE (Sidebar) --- */
        #palette-overlay { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20; display: none; justify-content: flex-end; }
        #palette { width: 85%; max-width: 320px; background: white; height: 100%; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; box-shadow: -2px 0 5px rgba(0,0,0,0.1); }
        .palette-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; align-items: center; }
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
        .p-item { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 14px; font-weight: bold; cursor: pointer; border: 1px solid #ddd; background: #fff; color: #555; transition: transform 0.1s; }
        .p-item:active { transform: scale(0.9); }
        
        /* Palette Colors */
        .p-item.answered { background: var(--correct); color: white; border-color: var(--correct); }
        .p-item.review { background: var(--review); color: white; border-color: var(--review); }
        .p-item.current { border: 2px solid var(--blue-current); transform: scale(1.1); box-shadow: 0 0 5px rgba(33, 150, 243, 0.4); }
        .p-item.skipped { background: var(--skipped); color: white; border-color: var(--skipped); } 

        /* Legend */
        .legend { margin-top: auto; padding-top: 20px; font-size: 12px; border-top: 1px solid #eee; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; color: #555; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }

        /* --- RESULT SCREEN --- */
        #result-screen { padding: 20px; overflow-y: auto; text-align: center; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; border: 10px solid var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 30px auto; font-size: 36px; font-weight: bold; color: var(--primary); background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Toast Notification */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 30; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <div id="home-screen" class="screen active">
        <div class="app-logo">üèóÔ∏è</div>
        <h1 style="color: var(--primary); margin-top:0;">RCC Test (Q66-92)</h1>
        
        <div class="stats-card">
            <h3 style="margin-top:0; color: var(--primary);">Your Progress</h3>
            <div class="stats-row"><span>Last Score:</span> <span id="last-score" style="font-weight:bold;">-</span></div>
            <div class="stats-row"><span>Accuracy:</span> <span id="last-accuracy" style="font-weight:bold;">-</span></div>
            <div class="stats-row" style="border:none;"><span>Tests Taken:</span> <span id="test-count">0</span></div>
        </div>

        <button class="btn-large" onclick="initTest('all')">
            <span>‚ñ∂</span> START TEST
        </button>
        <button class="btn-large btn-secondary" onclick="initTest('bookmark')">
            <span>üîñ</span> REVISE BOOKMARKS
        </button>
        <div style="margin-top:30px; font-size:11px; color:#999;">Ver 3.0 (Q66-92 Only)</div>
    </div>

    <div id="quiz-screen" class="screen">
        <header>
            <div id="timer" class="timer">02:00:00</div>
            <div class="header-icons">
                <div class="header-icon" onclick="submitTest()" title="Submit Test">‚úì</div>
                <div class="header-icon" onclick="exitTest()" title="Exit Test">‚úï</div>
            </div>
        </header>

        <div id="quiz-container">
            </div>

        <footer>
            <button class="nav-btn" onclick="navStep(-1)">Prev</button>
            <div class="center-actions">
                <button class="icon-btn" id="btn-bookmark" onclick="toggleBookmark()">üîñ</button>
                <button class="icon-btn" id="btn-review" onclick="toggleReview()">üü£</button>
                <button class="icon-btn" onclick="togglePalette()">‚ñ¶</button>
            </div>
            <button class="nav-btn primary" onclick="navStep(1)">Next</button>
        </footer>

        <div id="palette-overlay" onclick="togglePalette()">
            <div id="palette" onclick="event.stopPropagation()">
                <div class="palette-header">
                    <span>Question Grid</span>
                    <span onclick="togglePalette()" style="cursor:pointer; font-size:24px;">&times;</span>
                </div>
                <div class="palette-grid" id="palette-grid"></div>
                <div class="legend">
                    <div class="legend-item"><div class="dot" style="background:var(--correct)"></div> Answered</div>
                    <div class="legend-item"><div class="dot" style="background:var(--review)"></div> Review</div>
                    <div class="legend-item"><div class="dot" style="background:var(--skipped)"></div> Skipped</div>
                    <div class="legend-item"><div class="dot" style="border:2px solid var(--blue-current); background:transparent"></div> Current</div>
                </div>
            </div>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <h2>Test Result</h2>
        <div class="score-circle">
            <span id="score-text">0</span>
            <span style="font-size:14px; color:#666; font-weight:normal; margin-top:5px;">Score</span>
        </div>
        <div class="stats-card" style="margin: 0 auto 20px;">
            <div class="stats-row"><span>Total Questions:</span> <span id="res-total">0</span></div>
            <div class="stats-row"><span>Attempted:</span> <span id="res-attempted">0</span></div>
            <div class="stats-row"><span>Correct:</span> <span id="res-correct" style="color:var(--correct); font-weight:bold;">0</span></div>
            <div class="stats-row"><span>Wrong:</span> <span id="res-wrong" style="color:var(--wrong); font-weight:bold;">0</span></div>
            <div class="stats-row" style="border:none;"><span>Accuracy:</span> <span id="res-accuracy" style="font-weight:bold;">0%</span></div>
        </div>
        <button class="btn-large" onclick="goHome()">Back to Home</button>
    </div>

    <div id="toast">Message</div>

<script>
/* --- DATA DATABASE (Questions 66-92) --- */
const allQuestionsDB = [
    { id: 66, text: "For cantilever beam main reinforcement is placed at:", options: ["Bottom", "Centre", "Top", "Support"], ans: 2, tag: "ISRO TA 25.02.2018", explanation: "When a cantilever beam carries load, the upper fibre is in tension and bottom fibre in compression. Hence main reinforcement is provided to the upper fibre (Top)." },
    { id: 67, text: "When not specified, the volume of steel in R.C.C. work is taken as:", options: ["1% to 1.6%", "2% to 4%", "4% to 6%", "0.6% to 1%"], ans: 3, tag: "SSC JE 22.1.2018", explanation: "When not specified the volume of steel in R.C.C. work taken as 0.6 to 1% of R.C.C. Volume." },
    { id: 68, text: "As per IS 456, expansion joint provided for a structure, when the length exceeds:", options: ["40 m", "45 m", "50 m", "55 m"], ans: 1, tag: "KPSC JE Code 80/2014", explanation: "As per IS 456, expansion joint provided for a structure, when the length exceeds 45 m. (clause 27.2)" },
    { id: 69, text: "Fine aggregate confirming of which zone is not recommended for making reinforced concrete:", options: ["Zone I", "Zone II", "Zone III", "Zone IV"], ans: 3, tag: "KPSC Overseer 2017", explanation: "Fine aggregate belonging to zone-4 should not be used in RCC work unless tests have been made for suitability of mix proportion." },
    { id: 70, text: "The characteristic compressive strength of concrete used for construction in 35 N/mm¬≤. Its flexural strength according to IS 456:2000 will be:", options: ["10.21 N/mm¬≤", "17.5 N/mm¬≤", "12.5 N/mm¬≤", "4.14 N/mm¬≤"], ans: 3, tag: "MH PWD 2019", explanation: "Flexural strength (fcr) = 0.7‚àöfck = 0.7‚àö35 = 4.14 N/mm¬≤." },
    { id: 71, text: "According to IS : 456 : 2000, the minimum cement content to be used in a reinforced concrete structure in conditions of very severe exposure is :", options: ["340 kg/m¬≥", "360 kg/m¬≥", "320 kg/m¬≥", "300 kg/m¬≥"], ans: 0, tag: "PGCIL DET 17.11.2018", explanation: "Minimum cement content: Mild 300, Moderate 300, Severe 320, Very Severe 340, Extreme 360 kg/m¬≥." },
    { id: 72, text: "What is the range suggested by IS 456 : 2000 for the workability of concrete, measured in accordance with IS : 1199 the trench filling, where degree of workability is high?", options: ["Slump of 75-80 mm", "Slump of 25-50 mm", "Slump of 100-150 mm", "Slump of 50-75 mm"], ans: 2, tag: "PGCIL DET 17.11.2018", explanation: "As per IS 1199 for the slump value for trench filling (High workability) the slump value is about 100-150 mm." },
    { id: 73, text: "What is the level of severity given in IS 456 : 2000 for concrete exposed to condensation and rain?", options: ["Mild", "Severe", "Moderate", "Extreme"], ans: 2, tag: "PGCIL DET 17.11.2018", explanation: "Concrete exposed to condensation and rain falls under Moderate category." },
    { id: 74, text: "An 8 m span beam is casted today. What will be the minimum duration (days) before the props to the beam can be removed?", options: ["7", "28", "21", "14"], ans: 3, tag: "DDA JE 24.04.2018", explanation: "Props to beam and arches spanning over 6m: 14 days." },
    { id: 75, text: "It is the property of the material of a structure indicating the extent to which it can deform beyond the limit of yield deformation before failure or fracture is termed as:", options: ["Aspect ratio", "Slenderness ratio", "Ductility", "Brittleness"], ans: 2, tag: "DDA JE 24.04.2018", explanation: "The property of the material... indicating the extent to which it can deform beyond the limit of yield deformation is termed as ductility." },
    { id: 76, text: "If the standard deviation of 40 concrete cube samples is 3 MPa and the average is 30 MPa, then the co-efficient of variation (%) for this data set will be:", options: ["10", "1000", "1333", "4"], ans: 0, tag: "DDA JE 24.04.2018", explanation: "Coefficient of variation (CV) = (œÉ / Œº) * 100 = (3 / 30) * 100 = 10%." },
    { id: 77, text: "In a certain project... failure in aggregate crushing... left with only 10 mm aggregate and sand. How it affect the minimum cement content requirement?", options: ["The cement content will have to be reduced by 30 kg/cum.", "The cement content will have to be reduced by 40 kg/cum.", "The cement content will have to be increased by 40 kg/cum.", "The cement content will have to be increased by 30 kg/cum."], ans: 2, tag: "DDA JE 23.04.2018", explanation: "As per IS 456:2000 Table No. 6, Adjustment to minimum cement contents for aggregate 10 mm is +40 kg/m¬≥." },
    { id: 78, text: "A potential degradation of concrete can happen, if the Alkalies present in the cement react with:", options: ["Naphthalene present in the chemical admixture", "Potable water", "Silica present in aggregates", "Polypropylene fibres"], ans: 2, tag: "DDA JE 23.04.2018", explanation: "A potential degradation of concrete can happen, if the Alkalies present in the cement react with silica present in aggregates (Alkali-Aggregate Reaction)." },
    { id: 79, text: "In reinforced concrete walls, the ratio of the effective height to thickness is limited by design code to:", options: ["15", "20", "25", "30"], ans: 3, tag: "DDA JE 23.04.2018", explanation: "In reinforced concrete walls, the ratio of the effective height to thickness shall not exceed 30 (Clause 32.2.3)." },
    { id: 80, text: "What is the very first crack that occurs in any RCC member, especially if constructed during summer?", options: ["Flexural crack", "Settlement crack", "Corrosion spelling crack", "Shrinkage crack"], ans: 3, tag: "RRB JE 2019", explanation: "Shrinkage crack in concrete occurs due to change in moisture, during summer they absorb moisture and shrink during dry season." },
    { id: 81, text: "Vibrator used in concrete:", options: ["improves consolidation", "makes concrete stronger and durable", "removes voids in concrete", "all the above"], ans: 3, tag: "MIZORAM PSC 2010", explanation: "Vibrator used in concrete make concrete stronger and durable, improves consolidation and removes voids in concrete." },
    { id: 82, text: "What is the minimum nominal cover (mm) to be provided for reinforced concrete member exposed to severe weather conditions?", options: ["50", "35", "45", "40"], ans: 2, tag: "DDA JE 23.04.2018", explanation: "Nominal cover for severe exposure is 45 mm." },
    { id: 83, text: "For reinforced concrete members totally immersed in sea water, the additional cover thickness recommended by the code is:", options: ["25 mm", "30 mm", "35 mm", "45 mm"], ans: 0, tag: "SSC JE 2010", explanation: "The additional cover thickness is 25 mm." },
    { id: 84, text: "The self weight of the structure is called:", options: ["Dead load", "Wind load", "Live load", "Earthquake load"], ans: 0, tag: "UKSSSC JE 2020", explanation: "Self weight of structure -> Dead load." },
    { id: 85, text: "According to IS 1200, reinforcing bars used in reinforced cement concrete shall be measured in:", options: ["kg/m or tonne/m", "cubic meter", "square meter", "litre"], ans: 0, tag: "RRB SSE 2015", explanation: "Reinforcing bars used in reinforced cement concrete shall be measured in kg/m or tonne/m." },
    { id: 86, text: "Which test is used to determine the bending stress of steel?", options: ["Tensile strength test", "Compressive strength test", "Shear test", "Flexural strength test"], ans: 3, tag: "MP VYAPAM 2016", explanation: "Flexural strength test‚Äî Bending strength is defined as a material's ability to resist deformation under load." },
    { id: 87, text: "The type of environment exposure condition is called ____ when the concrete is exposed to severe rain, alternate wetting and drying.", options: ["Very severe", "Moderate", "Severe", "Mild"], ans: 2, tag: "YCT", explanation: "Exposure to severe rain, alternate wetting and drying is classified as 'Severe' environment." },
    { id: 88, text: "Consider the following statements concerning elasticity of concrete. <br>1. Stress-strain behaviour is a straight line up to 10% of ultimate strength. <br>2. Strain determination is obtained from tangent modules.", options: ["1, 2 & 3", "1 & 3", "1 & 2", "2 & 3"], ans: 2, tag: "ESE 2014", explanation: "Stress-strain behaviour is linear up to 30-40%. Modulus of elasticity is also called secant modulus." },
    { id: 89, text: "Which of the following is TRUE regarding stress-strain curve of concrete?", options: ["A straight line up to the failure.", "Hyperbolic up to 0.002% strain value and then a straight line up to failure.", "Parabolic up to 0.002 strain value and then a straight line up to failure.", "Straight line up to 0.002% strain value and then parabolic up to failure."], ans: 2, tag: "AAI 2015", explanation: "Parabolic up to 0.002 strain value and then a straight line up to 0.0035 strain value at failure." },
    { id: 90, text: "Generally the ratio of tensile strength to compressive strength of concrete is:", options: ["0.025", "0.040", "0.100", "0.400"], ans: 2, tag: "SJVNL JE 2018", explanation: "Tensile strength of concrete is approx 10% of its compressive strength." },
    { id: 91, text: "Maximum permissible limit of chlorides in water used for RCC shall be:", options: ["2000 mg/litre", "500 mg/litre", "300 mg/litre", "400 mg/litre"], ans: 1, tag: "ISRO TA 2018", explanation: "Maximum permissible limit of chlorides: For RCC = 500 mg/l. For PCC = 2000 mg/l." },
    { id: 92, text: "As per IS 456 : 2000 Maximum cement content in RCC shall be:", options: ["450 kg/m¬≥", "400 kg/m¬≥", "600 kg/m¬≥", "500 kg/m¬≥"], ans: 0, tag: "ISRO TA 2018", explanation: "Maximum cement content in RCC shall be 450 kg/m¬≥." }
];

/* --- STATE VARIABLES --- */
let activeQuestions = [];
let currentIndex = 0;
let userAnswers = {}; // { qId: optionIndex }
let reviewList = new Set();
let timerInterval;
let timeLeft;
let bookmarks = JSON.parse(localStorage.getItem('civilAppBookmarks_v3')) || [];
let history = JSON.parse(localStorage.getItem('civilAppHistory_v3')) || {score:0, total:0, accuracy:0, count:0};

/* --- INITIALIZATION --- */
window.onload = function() {
    updateHomeStats();
};

function updateHomeStats() {
    if(history.count > 0) {
        document.getElementById('last-score').innerText = `${history.score}/${history.total}`;
        document.getElementById('last-accuracy').innerText = `${history.accuracy}%`;
        document.getElementById('test-count').innerText = history.count;
    }
}

function showToast(msg) {
    const x = document.getElementById("toast");
    x.innerText = msg;
    x.className = "show";
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
}

/* --- CORE TEST FUNCTIONS --- */
function initTest(mode) {
    // 1. Determine Questions based on Mode
    if(mode === 'bookmark') {
        if(bookmarks.length === 0) {
            alert("No bookmarks saved yet! Go to Full Test and bookmark some questions.");
            return;
        }
        activeQuestions = allQuestionsDB.filter(q => bookmarks.includes(q.id));
    } else {
        activeQuestions = [...allQuestionsDB]; // Copy all
    }

    // 2. Reset State
    currentIndex = 0;
    userAnswers = {};
    reviewList.clear();
    timeLeft = (mode === 'bookmark') ? (activeQuestions.length * 90) : 7200; 

    // 3. Switch Screens
    document.querySelector('.active').classList.remove('active');
    document.getElementById('quiz-screen').classList.add('active');

    // 4. GENERATE PALETTE
    generatePalette();

    // 5. Render First Question & Start Timer
    renderQuestion();
    startTimer();
}

function generatePalette() {
    const grid = document.getElementById('palette-grid');
    grid.innerHTML = "";
    activeQuestions.forEach((q, idx) => {
        const item = document.createElement('div');
        item.className = 'p-item';
        item.innerText = idx + 1;
        item.id = `p-idx-${idx}`;
        item.onclick = () => {
            currentIndex = idx;
            renderQuestion();
            togglePalette();
        };
        grid.appendChild(item);
    });
}

function renderQuestion() {
    const q = activeQuestions[currentIndex];
    const container = document.getElementById('quiz-container');
    const isAnswered = userAnswers.hasOwnProperty(q.id);
    const selectedOpt = userAnswers[q.id];

    // Update Header Icons
    const isBookmarked = bookmarks.includes(q.id);
    const btnBook = document.getElementById('btn-bookmark');
    btnBook.innerText = isBookmarked ? "üè∑Ô∏è" : "üîñ";
    btnBook.classList.toggle('active-bookmark', isBookmarked);
    
    const isReview = reviewList.has(q.id);
    document.getElementById('btn-review').classList.toggle('active-review', isReview);

    let html = `
        <div class="question-card">
            <div class="q-meta">
                <span class="q-tag">${q.tag}</span>
                <span>Q.${currentIndex + 1} / ${activeQuestions.length}</span>
            </div>
            <div class="q-text">${q.text}</div>
            <ul class="options">
    `;

    q.options.forEach((opt, idx) => {
        let className = "option";
        
        if (isAnswered) {
            if (idx === q.ans) { className += " correct"; }
            else if (idx === selectedOpt) { className += " wrong"; }
            
            html += `<li class="${className}">
                <div class="option-circle">${idx===q.ans ? "‚úì" : (idx===selectedOpt ? "‚úï" : "")}</div>
                ${opt}
            </li>`;
        } else {
            html += `<li class="${className}" onclick="handleAnswer(${idx})">
                <div class="option-circle"></div>
                ${opt}
            </li>`;
        }
    });

    html += `</ul>`;

    if (isAnswered) {
        html += `
            <div class="solution-box" style="display:block">
                <div class="solution-header">üìã Solution Report</div>
                ${q.explanation}
            </div>
        `;
    }

    html += `</div>`;
    container.innerHTML = html;
    
    updatePaletteUI();
}

function updatePaletteUI() {
    activeQuestions.forEach((q, idx) => {
        const el = document.getElementById(`p-idx-${idx}`);
        if(!el) return;

        el.className = 'p-item'; // Reset
        if (currentIndex === idx) el.classList.add('current');
        
        if (userAnswers.hasOwnProperty(q.id)) {
            el.classList.add('answered');
        } else if (reviewList.has(q.id)) {
            el.classList.add('review');
        } else if (idx < currentIndex && !userAnswers.hasOwnProperty(q.id)) {
             el.classList.add('skipped');
        }
    });
}

function handleAnswer(optIdx) {
    const q = activeQuestions[currentIndex];
    userAnswers[q.id] = optIdx;
    renderQuestion(); 
}

function navStep(step) {
    const newIndex = currentIndex + step;
    if (newIndex >= 0 && newIndex < activeQuestions.length) {
        currentIndex = newIndex;
        renderQuestion();
    }
}

/* --- FEATURES --- */
function toggleBookmark() {
    const qId = activeQuestions[currentIndex].id;
    if(bookmarks.includes(qId)) {
        bookmarks = bookmarks.filter(id => id !== qId);
        showToast("Removed from Bookmarks");
    } else {
        bookmarks.push(qId);
        showToast("Added to Bookmarks");
    }
    localStorage.setItem('civilAppBookmarks_v3', JSON.stringify(bookmarks));
    renderQuestion();
}

function toggleReview() {
    const qId = activeQuestions[currentIndex].id;
    if (reviewList.has(qId)) {
        reviewList.delete(qId);
        showToast("Unmarked from Review");
    } else {
        reviewList.add(qId);
        showToast("Marked for Review");
    }
    renderQuestion();
    updatePaletteUI();
}

function togglePalette() {
    const overlay = document.getElementById('palette-overlay');
    const isVisible = overlay.style.display === 'flex';
    overlay.style.display = isVisible ? 'none' : 'flex';
}

function startTimer() {
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        timeLeft--;
        const hours = Math.floor(timeLeft / 3600).toString().padStart(2, '0');
        const mins = Math.floor((timeLeft % 3600) / 60).toString().padStart(2, '0');
        const secs = (timeLeft % 60).toString().padStart(2, '0');
        document.getElementById('timer').innerText = `${hours}:${mins}:${secs}`;
        if (timeLeft <= 0) submitTest();
    }, 1000);
}

function exitTest() {
    if(confirm("Exit Test? Progress will be lost.")) {
        goHome();
    }
}

function goHome() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('home-screen').classList.add('active');
    clearInterval(timerInterval);
    updateHomeStats();
}

function submitTest() {
    if(!confirm("Are you sure you want to submit?")) return;
    
    clearInterval(timerInterval);
    document.querySelector('.active').classList.remove('active');
    document.getElementById('result-screen').classList.add('active');

    let correct = 0;
    let wrong = 0;
    
    activeQuestions.forEach(q => {
        if(userAnswers.hasOwnProperty(q.id)) {
            if(userAnswers[q.id] === q.ans) correct++;
            else wrong++;
        }
    });

    const attempted = Object.keys(userAnswers).length;
    const accuracy = attempted > 0 ? Math.round((correct / attempted) * 100) : 0;
    const total = activeQuestions.length;

    document.getElementById('score-text').innerText = correct;
    document.getElementById('res-total').innerText = total;
    document.getElementById('res-attempted').innerText = attempted;
    document.getElementById('res-correct').innerText = correct;
    document.getElementById('res-wrong').innerText = wrong;
    document.getElementById('res-accuracy').innerText = accuracy + "%";

    // Update Global History 
    history = { 
        score: correct, 
        total: total, 
        accuracy: accuracy, 
        count: (history.count || 0) + 1 
    };
    localStorage.setItem('civilAppHistory_v3', JSON.stringify(history));
}
</script>
</body>
</html>

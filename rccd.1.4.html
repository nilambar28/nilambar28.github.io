<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCC Test (Q93-121)</title>
    <style>
        :root {
            --primary: #e91e63;
            --primary-dark: #c2185b;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --correct: #4caf50;
            --wrong: #f44336;
            --review: #9c27b0;
            --blue-current: #2196f3;
            --skipped: #9e9e9e;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); color: var(--text-color); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- SCREENS --- */
        .screen { display: none; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* --- HOME SCREEN --- */
        #home-screen { align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .app-logo { font-size: 50px; margin-bottom: 20px; }
        .stats-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 350px; margin-bottom: 20px; text-align: left; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .btn-large { background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; max-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); margin-top: 15px; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-large:active { transform: scale(0.98); }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); margin-top: 15px; }

        /* --- HEADER --- */
        header { background: var(--primary); color: white; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; flex-shrink: 0; }
        .timer { font-weight: bold; font-size: 18px; font-family: monospace; background: rgba(0,0,0,0.1); padding: 5px 10px; border-radius: 4px; }
        .header-icons { display: flex; gap: 20px; align-items: center; }
        .header-icon { cursor: pointer; font-size: 20px; font-weight: bold; display: flex; align-items: center; justify-content: center; width: 35px; height: 35px; border-radius: 50%; transition: background 0.2s; }
        .header-icon:active { background: rgba(255,255,255,0.2); }
        
        /* --- MAIN TEST AREA --- */
        #quiz-container { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; position: relative; background: #f0f2f5; }
        .question-card { background: var(--card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .q-meta { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .q-tag { background: #e3f2fd; color: #1565c0; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .q-text { font-size: 16px; font-weight: 500; margin-bottom: 20px; line-height: 1.5; color: #000; }
        
        .options { list-style: none; padding: 0; }
        .option { padding: 14px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s; background: #fff; }
        .option-circle { height: 22px; width: 22px; border: 2px solid #ccc; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 12px; font-weight: bold; color: white; }
        
        /* Interaction States */
        .option.selected { border-color: var(--blue-current); background: #e3f2fd; }
        .option.correct { border-color: var(--correct); background: #e8f5e9; }
        .option.wrong { border-color: var(--wrong); background: #ffebee; }
        
        .option.correct .option-circle { border-color: var(--correct); background: var(--correct); content: "‚úì"; }
        .option.wrong .option-circle { border-color: var(--wrong); background: var(--wrong); content: "‚úï"; }

        /* --- SOLUTION BOX --- */
        .solution-box { display: none; margin-top: 20px; background: #f8f9fa; padding: 15px; border-left: 4px solid var(--primary); border-radius: 4px; font-size: 14px; color: #444; line-height: 1.5; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .solution-header { font-weight: bold; color: var(--primary); margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }

        /* --- FOOTER --- */
        footer { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; height: 60px; z-index: 10; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .nav-btn { background: white; border: 1px solid #ccc; padding: 8px 18px; border-radius: 20px; font-weight: bold; color: #555; cursor: pointer; font-size: 14px; }
        .nav-btn.primary { background: var(--primary); color: white; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .center-actions { display: flex; gap: 20px; }
        .icon-btn { font-size: 24px; padding: 0; border: none; background: none; color: #757575; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; }
        .icon-btn:active { background: #eee; }
        .icon-btn.active-review { color: var(--review); }
        .icon-btn.active-bookmark { color: #ff9800; }

        /* --- PALETTE (Sidebar) --- */
        #palette-overlay { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20; display: none; justify-content: flex-end; }
        #palette { width: 85%; max-width: 320px; background: white; height: 100%; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; box-shadow: -2px 0 5px rgba(0,0,0,0.1); }
        .palette-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; align-items: center; }
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
        .p-item { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 14px; font-weight: bold; cursor: pointer; border: 1px solid #ddd; background: #fff; color: #555; transition: transform 0.1s; }
        .p-item:active { transform: scale(0.9); }
        
        /* Palette Colors */
        .p-item.answered { background: var(--correct); color: white; border-color: var(--correct); }
        .p-item.review { background: var(--review); color: white; border-color: var(--review); }
        .p-item.current { border: 2px solid var(--blue-current); transform: scale(1.1); box-shadow: 0 0 5px rgba(33, 150, 243, 0.4); }
        .p-item.skipped { background: var(--skipped); color: white; border-color: var(--skipped); } 

        /* Legend */
        .legend { margin-top: auto; padding-top: 20px; font-size: 12px; border-top: 1px solid #eee; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; color: #555; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }

        /* --- RESULT SCREEN --- */
        #result-screen { padding: 20px; overflow-y: auto; text-align: center; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; border: 10px solid var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 30px auto; font-size: 36px; font-weight: bold; color: var(--primary); background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Toast Notification */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 30; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <div id="home-screen" class="screen active">
        <div class="app-logo">üèóÔ∏è</div>
        <h1 style="color: var(--primary); margin-top:0;">RCC Test (Q93-121)</h1>
        
        <div class="stats-card">
            <h3 style="margin-top:0; color: var(--primary);">Your Progress</h3>
            <div class="stats-row"><span>Last Score:</span> <span id="last-score" style="font-weight:bold;">-</span></div>
            <div class="stats-row"><span>Accuracy:</span> <span id="last-accuracy" style="font-weight:bold;">-</span></div>
            <div class="stats-row" style="border:none;"><span>Tests Taken:</span> <span id="test-count">0</span></div>
        </div>

        <button class="btn-large" onclick="initTest('all')">
            <span>‚ñ∂</span> START TEST
        </button>
        <button class="btn-large btn-secondary" onclick="initTest('bookmark')">
            <span>üîñ</span> REVISE BOOKMARKS
        </button>
        <div style="margin-top:30px; font-size:11px; color:#999;">Ver 4.0 (Q93-121 Only)</div>
    </div>

    <div id="quiz-screen" class="screen">
        <header>
            <div id="timer" class="timer">02:00:00</div>
            <div class="header-icons">
                <div class="header-icon" onclick="submitTest()" title="Submit Test">‚úì</div>
                <div class="header-icon" onclick="exitTest()" title="Exit Test">‚úï</div>
            </div>
        </header>

        <div id="quiz-container">
            </div>

        <footer>
            <button class="nav-btn" onclick="navStep(-1)">Prev</button>
            <div class="center-actions">
                <button class="icon-btn" id="btn-bookmark" onclick="toggleBookmark()">üîñ</button>
                <button class="icon-btn" id="btn-review" onclick="toggleReview()">üü£</button>
                <button class="icon-btn" onclick="togglePalette()">‚ñ¶</button>
            </div>
            <button class="nav-btn primary" onclick="navStep(1)">Next</button>
        </footer>

        <div id="palette-overlay" onclick="togglePalette()">
            <div id="palette" onclick="event.stopPropagation()">
                <div class="palette-header">
                    <span>Question Grid</span>
                    <span onclick="togglePalette()" style="cursor:pointer; font-size:24px;">&times;</span>
                </div>
                <div class="palette-grid" id="palette-grid"></div>
                <div class="legend">
                    <div class="legend-item"><div class="dot" style="background:var(--correct)"></div> Answered</div>
                    <div class="legend-item"><div class="dot" style="background:var(--review)"></div> Review</div>
                    <div class="legend-item"><div class="dot" style="background:var(--skipped)"></div> Skipped</div>
                    <div class="legend-item"><div class="dot" style="border:2px solid var(--blue-current); background:transparent"></div> Current</div>
                </div>
            </div>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <h2>Test Result</h2>
        <div class="score-circle">
            <span id="score-text">0</span>
            <span style="font-size:14px; color:#666; font-weight:normal; margin-top:5px;">Score</span>
        </div>
        <div class="stats-card" style="margin: 0 auto 20px;">
            <div class="stats-row"><span>Total Questions:</span> <span id="res-total">0</span></div>
            <div class="stats-row"><span>Attempted:</span> <span id="res-attempted">0</span></div>
            <div class="stats-row"><span>Correct:</span> <span id="res-correct" style="color:var(--correct); font-weight:bold;">0</span></div>
            <div class="stats-row"><span>Wrong:</span> <span id="res-wrong" style="color:var(--wrong); font-weight:bold;">0</span></div>
            <div class="stats-row" style="border:none;"><span>Accuracy:</span> <span id="res-accuracy" style="font-weight:bold;">0%</span></div>
        </div>
        <button class="btn-large" onclick="goHome()">Back to Home</button>
    </div>

    <div id="toast">Message</div>

<script>
/* --- DATA DATABASE (Questions 93-121) --- */
const allQuestionsDB = [
    { id: 93, text: "As per IS 456 : 2000 high strength concrete shall be", options: ["M40 and above", "M50 and above", "M60 and above", "M80 and above"], ans: 2, tag: "ISRO TA 08.04.2018", explanation: "As per IS 456:2000, High strength concrete is classified as M60 and above. (M10-M20: Ordinary, M25-M55/M60: Standard, M60-M100: High)." },
    { id: 94, text: "Minimum grade of reinforced concrete used for moderate exposure", options: ["M65", "M20", "M40", "M25"], ans: 3, tag: "MH PWD 2019", explanation: "For moderate exposure, minimum grade of reinforced concrete is M25 with min cement content 300 kg/m¬≥ and max w/c 0.50." },
    { id: 95, text: "The grade of concrete upto which nominal mix can be adopted", options: ["M30 or lower", "M15 or lower", "M25 or lower", "M20 or lower"], ans: 3, tag: "Gujarat Electric Board 2017", explanation: "Nominal mix concrete is called nominal or standard mix. Usually this method is suitable grade of concrete upto M20 or lower." },
    { id: 96, text: "Mix ratio of M20 grade cement concrete is", options: ["1:3:6", "1:4:8", "1:2:4", "1:1.5:3"], ans: 3, tag: "Mizoram PSC JE 2016", explanation: "M20 grade ratio is 1:1.5:3. (M15 is 1:2:4, M10 is 1:3:6)." },
    { id: 97, text: "The minimum compressive strength of 53 grade cement is :", options: ["25 N/mm¬≤", "53 N/mm¬≤", "25 kN/mm¬≤", "53 kN/mm¬≤"], ans: 1, tag: "MP VYAPAM Sub Engg 2018", explanation: "For 53 grade cement IS 12269, min compressive strength is 53 N/mm¬≤ (MPa) at 28 days." },
    { id: 98, text: "Characteristic design load is equal to ____.", options: ["mean load / (k x s)", "Mean load + floor finishing load", "Mean load + k x s", "Mean load - k x s"], ans: 2, tag: "MP VYAPAM Sub Engg 2017", explanation: "Characteristic load = Mean Load + (k √ó s), where only 5% load will fall above this value." },
    { id: 99, text: "As per IS : 456-2000, the nominal concrete cover in mm for 'severe durability of concrete' is", options: ["45", "50", "30", "20"], ans: 0, tag: "MP VYAPAM Sub Engg 2017", explanation: "Nominal cover for Severe durability is 45 mm. (Mild: 20, Moderate: 30, Severe: 45, Very Severe: 50, Extreme: 75)." },
    { id: 100, text: "Which following equation gives the relationship between central point loading and third point loading in flexural strength test?", options: ["X1 = X2 + 0.72", "X1 = X2 + 0.96", "X2 = X1 + 0.72", "X2 = X1 + 0.96"], ans: 0, tag: "MP VYAPAM Sub Engg 2017", explanation: "For determining flexural strength/modulus of rupture: X1 = X2 + 0.72, where X1 = flexural strength of concrete, X2 = flexural strength under third point load." },
    { id: 101, text: "Evaluate the tensile strength of concrete of grade M 40", options: ["4.42 N/mm¬≤", "4.70 N/mm¬≤", "4.14 N/mm¬≤", "4.95 N/mm¬≤"], ans: 0, tag: "M.P. VYAPAM Sub Engg 2018", explanation: "Flexural tensile strength = 0.7‚àöfck = 0.7‚àö40 = 0.7 √ó 6.32 = 4.42 N/mm¬≤." },
    { id: 102, text: "As per IS 456 the approximate ratio of the strength of concrete of 7 days to that of 28 days is", options: ["0.65", "0.85", "1.0", "1.5"], ans: 0, tag: "Nagaland PSC 2015", explanation: "Strength at 7 days is approximately 65% (0.65) of the 28 days strength." },
    { id: 103, text: "Once structure constructed by R.C.C. No ......... is possible.", options: ["Binding", "Concrete work", "Workmanship", "Alternation"], ans: 0, tag: "HPSSC JE 2018", explanation: "Ans. (a): Once structure constructed by RCC no binding is possible because... (Note: This question phrasing is specific to the source provided)." },
    { id: 104, text: "According to IS 456-2000, the minimum grade of concrete with maximum free water to cement ratio of 0.5 and minimum cement content of 300 kg/m¬≥ is", options: ["M 20", "M 30", "M 25", "M 35"], ans: 2, tag: "KPSC JE 10.09.2017", explanation: "The conditions (Max w/c 0.5, Min Cement 300) correspond to Moderate exposure, which requires Min Grade M25." },
    { id: 105, text: "As per IS : 10262 : 2009, the standard deviation for M25 concrete is :", options: ["4.0", "3.5", "4.5", "5.0"], ans: 0, tag: "PGCIL 13.09.2018", explanation: "Standard deviation for M20 and M25 is 4.0 N/mm¬≤." },
    { id: 106, text: "As per IS specifications, the nominal concrete cover for moderate exposure should not be less than", options: ["20mm", "30mm", "45mm", "50mm"], ans: 1, tag: "HSSC JE 2018", explanation: "Nominal cover for moderate exposure should not be less than 30 mm." },
    { id: 107, text: "Ordinary concrete is not used for concrete", options: ["M 10", "M 15", "M 20", "M 40"], ans: 3, tag: "SSC JE 2009", explanation: "Ordinary concrete is M10-M20. M40 falls under Standard Concrete (M25-M60). M40 is used for pre-tensioned/pre-stressed work." },
    { id: 108, text: "The minimum cement content (kg/cum) for a ship dock (underwater construction) with 40 mm aggregate is prescribed by the India Standard as:", options: ["300", "250", "400", "350"], ans: 3, tag: "DDA JE 23.04.2018", explanation: "For underwater construction (Extreme conditions), min cement content is typically high. The question specifies 350 kg/m¬≥ for ship dock." },
    { id: 109, text: "TMT stands for‚Äì", options: ["Thermo Mechanically Treated", "Tread Mill Test", "Both (a) and (b)", "None of these"], ans: 0, tag: "MH PWD 2016", explanation: "TMT stands for Thermo Mechanically Treated bars." },
    { id: 110, text: "Which one of the following methods reduces the effect of creep?", options: ["Using high strength concrete", "Adding reinforcement", "Steam curing under pressure", "All of the above"], ans: 3, tag: "MH PWD 2019", explanation: "Creep can be reduced by using high strength concrete, adding reinforcement, delaying loading, and steam curing." },
    { id: 111, text: "As per IS-456-1978 the pH value of water shall be", options: ["less than 6", "equal to 6", "not less than 6", "equal to 7"], ans: 2, tag: "GPSC AM 2020", explanation: "The pH value of water shall be not less than 6 because acidic water is harmful to concrete." },
    { id: 112, text: "The unit weight of reinforced cement concrete according to IS 875-1987 is", options: ["2200 kg/m¬≥", "2300 kg/m¬≥", "2400 kg/m¬≥", "2500 kg/m¬≥"], ans: 3, tag: "WBPSC JE 2018", explanation: "Unit weight: PCC = 2400 kg/m¬≥, RCC = 2500 kg/m¬≥." },
    { id: 113, text: "Which of the following is not a common size of reinforcement bars?", options: ["16 mm", "28 mm", "20 mm", "25 mm"], ans: 1, tag: "KPSC JE Code 115/2014", explanation: "Standard sizes are 6, 8, 10, 12, 16, 20, 25, 32... 28mm is not a common standard size." },
    { id: 114, text: "The value of the strength of the material below which not more than 5 percent of the test results are expected to fall", options: ["Allowable strength", "Working strength", "Maximum strength", "Characteristic strength"], ans: 3, tag: "KPSC Overseer 2020", explanation: "Characteristic strength is the strength below which not more than 5% of test results are expected to fall." },
    { id: 115, text: "As per IS - 456 : 2000, the characteristic compressive strength of concrete at 28 days in N/mm¬≤ is given with reference to a :", options: ["150 mm diameter cylinder", "Dog bone shape", "100 mm cube", "150 mm cube"], ans: 3, tag: "PGCIL 13.09.2018", explanation: "Characteristic compressive strength is measured using a 150 mm cube." },
    { id: 116, text: "The flexural strength of M30 concrete as per IS 456 is :", options: ["3.83 MPa", "5.47 MPa", "21.23 MPa", "30 MPa"], ans: 0, tag: "UPRVUNL JE 2014", explanation: "fcr = 0.7‚àöfck = 0.7‚àö30 = 3.83 MPa." },
    { id: 117, text: "What is the value of Young's modulus for M25 concrete as per IS 456:2000?", options: ["2 √ó 10‚Åµ MPa", "2.5 √ó 10‚Å¥ MPa", "2.2 √ó 10‚Åµ MPa", "1.5 √ó 10‚Åµ MPa"], ans: 1, tag: "SSC JE 25.09.2019", explanation: "Ec = 5000‚àöfck = 5000‚àö25 = 25000 MPa = 2.5 √ó 10‚Å¥ MPa." },
    { id: 118, text: "As per IS 456:2000... stripping time (in days) of props to slabs spanning up to 4.5 m may be taken as :", options: ["1 day", "3 days", "7 days", "14 days"], ans: 2, tag: "HPSSC JE Code 552/2018", explanation: "Stripping time for slabs spanning up to 4.5 m is 7 days." },
    { id: 119, text: "A reinforced cement concrete beam is considered to be made of", options: ["homogeneous material", "heterogeneous material", "expose material", "isotropic material"], ans: 1, tag: "GSSSB Surveyor 2016", explanation: "RCC is considered a heterogeneous material because it is a combination of concrete and steel." },
    { id: 120, text: "What is the compressive strength after 28 days for M 20 concrete?", options: ["10 N/sq.mm", "20 N/sq.mm", "30 N/sq.mm", "40 N/sq.mm"], ans: 1, tag: "HSSC JE CAT 35 2016", explanation: "In M20, 20 indicates the characteristic compressive strength in N/mm¬≤ at 28 days." },
    { id: 121, text: "What is the density of normal concrete?", options: ["2200 to 2600 kg/cu.m", "2000 to 2400 kg/cu.m", "2000 to 2200 kg/cu.m", "2200 to 2300 kg/cu.m"], ans: 0, tag: "HSSC JE CAT 35 2016", explanation: "Density of reinforced concrete is typically taken as 2400-2500 kg/m¬≥. The range 2200-2600 covers this." }
];

/* --- STATE VARIABLES --- */
let activeQuestions = [];
let currentIndex = 0;
let userAnswers = {}; // { qId: optionIndex }
let reviewList = new Set();
let timerInterval;
let timeLeft;
let bookmarks = JSON.parse(localStorage.getItem('civilAppBookmarks_v4')) || [];
let history = JSON.parse(localStorage.getItem('civilAppHistory_v4')) || {score:0, total:0, accuracy:0, count:0};

/* --- INITIALIZATION --- */
window.onload = function() {
    updateHomeStats();
};

function updateHomeStats() {
    if(history.count > 0) {
        document.getElementById('last-score').innerText = `${history.score}/${history.total}`;
        document.getElementById('last-accuracy').innerText = `${history.accuracy}%`;
        document.getElementById('test-count').innerText = history.count;
    }
}

function showToast(msg) {
    const x = document.getElementById("toast");
    x.innerText = msg;
    x.className = "show";
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
}

/* --- CORE TEST FUNCTIONS --- */
function initTest(mode) {
    // 1. Determine Questions based on Mode
    if(mode === 'bookmark') {
        if(bookmarks.length === 0) {
            alert("No bookmarks saved yet! Go to Full Test and bookmark some questions.");
            return;
        }
        activeQuestions = allQuestionsDB.filter(q => bookmarks.includes(q.id));
    } else {
        activeQuestions = [...allQuestionsDB]; // Copy all
    }

    // 2. Reset State
    currentIndex = 0;
    userAnswers = {};
    reviewList.clear();
    timeLeft = (mode === 'bookmark') ? (activeQuestions.length * 90) : 7200; 

    // 3. Switch Screens
    document.querySelector('.active').classList.remove('active');
    document.getElementById('quiz-screen').classList.add('active');

    // 4. GENERATE PALETTE
    generatePalette();

    // 5. Render First Question & Start Timer
    renderQuestion();
    startTimer();
}

function generatePalette() {
    const grid = document.getElementById('palette-grid');
    grid.innerHTML = "";
    activeQuestions.forEach((q, idx) => {
        const item = document.createElement('div');
        item.className = 'p-item';
        item.innerText = idx + 1;
        item.id = `p-idx-${idx}`;
        item.onclick = () => {
            currentIndex = idx;
            renderQuestion();
            togglePalette();
        };
        grid.appendChild(item);
    });
}

function renderQuestion() {
    const q = activeQuestions[currentIndex];
    const container = document.getElementById('quiz-container');
    const isAnswered = userAnswers.hasOwnProperty(q.id);
    const selectedOpt = userAnswers[q.id];

    // Update Header Icons
    const isBookmarked = bookmarks.includes(q.id);
    const btnBook = document.getElementById('btn-bookmark');
    btnBook.innerText = isBookmarked ? "üè∑Ô∏è" : "üîñ";
    btnBook.classList.toggle('active-bookmark', isBookmarked);
    
    const isReview = reviewList.has(q.id);
    document.getElementById('btn-review').classList.toggle('active-review', isReview);

    let html = `
        <div class="question-card">
            <div class="q-meta">
                <span class="q-tag">${q.tag}</span>
                <span>Q.${currentIndex + 1} / ${activeQuestions.length}</span>
            </div>
            <div class="q-text">${q.text}</div>
            <ul class="options">
    `;

    q.options.forEach((opt, idx) => {
        let className = "option";
        
        if (isAnswered) {
            if (idx === q.ans) { className += " correct"; }
            else if (idx === selectedOpt) { className += " wrong"; }
            
            html += `<li class="${className}">
                <div class="option-circle">${idx===q.ans ? "‚úì" : (idx===selectedOpt ? "‚úï" : "")}</div>
                ${opt}
            </li>`;
        } else {
            html += `<li class="${className}" onclick="handleAnswer(${idx})">
                <div class="option-circle"></div>
                ${opt}
            </li>`;
        }
    });

    html += `</ul>`;

    if (isAnswered) {
        html += `
            <div class="solution-box" style="display:block">
                <div class="solution-header">üìã Solution Report</div>
                ${q.explanation}
            </div>
        `;
    }

    html += `</div>`;
    container.innerHTML = html;
    
    updatePaletteUI();
}

function updatePaletteUI() {
    activeQuestions.forEach((q, idx) => {
        const el = document.getElementById(`p-idx-${idx}`);
        if(!el) return;

        el.className = 'p-item'; // Reset
        if (currentIndex === idx) el.classList.add('current');
        
        if (userAnswers.hasOwnProperty(q.id)) {
            el.classList.add('answered');
        } else if (reviewList.has(q.id)) {
            el.classList.add('review');
        } else if (idx < currentIndex && !userAnswers.hasOwnProperty(q.id)) {
             el.classList.add('skipped');
        }
    });
}

function handleAnswer(optIdx) {
    const q = activeQuestions[currentIndex];
    userAnswers[q.id] = optIdx;
    renderQuestion(); 
}

function navStep(step) {
    const newIndex = currentIndex + step;
    if (newIndex >= 0 && newIndex < activeQuestions.length) {
        currentIndex = newIndex;
        renderQuestion();
    }
}

/* --- FEATURES --- */
function toggleBookmark() {
    const qId = activeQuestions[currentIndex].id;
    if(bookmarks.includes(qId)) {
        bookmarks = bookmarks.filter(id => id !== qId);
        showToast("Removed from Bookmarks");
    } else {
        bookmarks.push(qId);
        showToast("Added to Bookmarks");
    }
    localStorage.setItem('civilAppBookmarks_v4', JSON.stringify(bookmarks));
    renderQuestion();
}

function toggleReview() {
    const qId = activeQuestions[currentIndex].id;
    if (reviewList.has(qId)) {
        reviewList.delete(qId);
        showToast("Unmarked from Review");
    } else {
        reviewList.add(qId);
        showToast("Marked for Review");
    }
    renderQuestion();
    updatePaletteUI();
}

function togglePalette() {
    const overlay = document.getElementById('palette-overlay');
    const isVisible = overlay.style.display === 'flex';
    overlay.style.display = isVisible ? 'none' : 'flex';
}

function startTimer() {
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        timeLeft--;
        const hours = Math.floor(timeLeft / 3600).toString().padStart(2, '0');
        const mins = Math.floor((timeLeft % 3600) / 60).toString().padStart(2, '0');
        const secs = (timeLeft % 60).toString().padStart(2, '0');
        document.getElementById('timer').innerText = `${hours}:${mins}:${secs}`;
        if (timeLeft <= 0) submitTest();
    }, 1000);
}

function exitTest() {
    if(confirm("Exit Test? Progress will be lost.")) {
        goHome();
    }
}

function goHome() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('home-screen').classList.add('active');
    clearInterval(timerInterval);
    updateHomeStats();
}

function submitTest() {
    if(!confirm("Are you sure you want to submit?")) return;
    
    clearInterval(timerInterval);
    document.querySelector('.active').classList.remove('active');
    document.getElementById('result-screen').classList.add('active');

    let correct = 0;
    let wrong = 0;
    
    activeQuestions.forEach(q => {
        if(userAnswers.hasOwnProperty(q.id)) {
            if(userAnswers[q.id] === q.ans) correct++;
            else wrong++;
        }
    });

    const attempted = Object.keys(userAnswers).length;
    const accuracy = attempted > 0 ? Math.round((correct / attempted) * 100) : 0;
    const total = activeQuestions.length;

    document.getElementById('score-text').innerText = correct;
    document.getElementById('res-total').innerText = total;
    document.getElementById('res-attempted').innerText = attempted;
    document.getElementById('res-correct').innerText = correct;
    document.getElementById('res-wrong').innerText = wrong;
    document.getElementById('res-accuracy').innerText = accuracy + "%";

    // Update Global History 
    history = { 
        score: correct, 
        total: total, 
        accuracy: accuracy, 
        count: (history.count || 0) + 1 
    };
    localStorage.setItem('civilAppHistory_v4', JSON.stringify(history));
}
</script>
</body>
</html>

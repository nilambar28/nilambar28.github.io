<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCC Test (Q122-155)</title>
    <style>
        :root {
            --primary: #e91e63;
            --primary-dark: #c2185b;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --correct: #4caf50;
            --wrong: #f44336;
            --review: #9c27b0;
            --blue-current: #2196f3;
            --skipped: #9e9e9e;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); color: var(--text-color); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- SCREENS --- */
        .screen { display: none; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* --- HOME SCREEN --- */
        #home-screen { align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .app-logo { font-size: 50px; margin-bottom: 20px; }
        .stats-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 350px; margin-bottom: 20px; text-align: left; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .btn-large { background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; max-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); margin-top: 15px; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-large:active { transform: scale(0.98); }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); margin-top: 15px; }

        /* --- HEADER --- */
        header { background: var(--primary); color: white; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; flex-shrink: 0; }
        .timer { font-weight: bold; font-size: 18px; font-family: monospace; background: rgba(0,0,0,0.1); padding: 5px 10px; border-radius: 4px; }
        .header-icons { display: flex; gap: 20px; align-items: center; }
        .header-icon { cursor: pointer; font-size: 20px; font-weight: bold; display: flex; align-items: center; justify-content: center; width: 35px; height: 35px; border-radius: 50%; transition: background 0.2s; }
        .header-icon:active { background: rgba(255,255,255,0.2); }
        
        /* --- MAIN TEST AREA --- */
        #quiz-container { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; position: relative; background: #f0f2f5; }
        .question-card { background: var(--card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .q-meta { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .q-tag { background: #e3f2fd; color: #1565c0; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .q-text { font-size: 16px; font-weight: 500; margin-bottom: 20px; line-height: 1.5; color: #000; }
        
        .options { list-style: none; padding: 0; }
        .option { padding: 14px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s; background: #fff; }
        .option-circle { height: 22px; width: 22px; border: 2px solid #ccc; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 12px; font-weight: bold; color: white; }
        
        /* Interaction States */
        .option.selected { border-color: var(--blue-current); background: #e3f2fd; }
        .option.correct { border-color: var(--correct); background: #e8f5e9; }
        .option.wrong { border-color: var(--wrong); background: #ffebee; }
        
        .option.correct .option-circle { border-color: var(--correct); background: var(--correct); content: "‚úì"; }
        .option.wrong .option-circle { border-color: var(--wrong); background: var(--wrong); content: "‚úï"; }

        /* --- SOLUTION BOX --- */
        .solution-box { display: none; margin-top: 20px; background: #f8f9fa; padding: 15px; border-left: 4px solid var(--primary); border-radius: 4px; font-size: 14px; color: #444; line-height: 1.5; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .solution-header { font-weight: bold; color: var(--primary); margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }

        /* --- FOOTER --- */
        footer { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; height: 60px; z-index: 10; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .nav-btn { background: white; border: 1px solid #ccc; padding: 8px 18px; border-radius: 20px; font-weight: bold; color: #555; cursor: pointer; font-size: 14px; }
        .nav-btn.primary { background: var(--primary); color: white; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .center-actions { display: flex; gap: 20px; }
        .icon-btn { font-size: 24px; padding: 0; border: none; background: none; color: #757575; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; }
        .icon-btn:active { background: #eee; }
        .icon-btn.active-review { color: var(--review); }
        .icon-btn.active-bookmark { color: #ff9800; }

        /* --- PALETTE (Sidebar) --- */
        #palette-overlay { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20; display: none; justify-content: flex-end; }
        #palette { width: 85%; max-width: 320px; background: white; height: 100%; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; box-shadow: -2px 0 5px rgba(0,0,0,0.1); }
        .palette-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; align-items: center; }
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
        .p-item { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 14px; font-weight: bold; cursor: pointer; border: 1px solid #ddd; background: #fff; color: #555; transition: transform 0.1s; }
        .p-item:active { transform: scale(0.9); }
        
        /* Palette Colors */
        .p-item.answered { background: var(--correct); color: white; border-color: var(--correct); }
        .p-item.review { background: var(--review); color: white; border-color: var(--review); }
        .p-item.current { border: 2px solid var(--blue-current); transform: scale(1.1); box-shadow: 0 0 5px rgba(33, 150, 243, 0.4); }
        .p-item.skipped { background: var(--skipped); color: white; border-color: var(--skipped); } 

        /* Legend */
        .legend { margin-top: auto; padding-top: 20px; font-size: 12px; border-top: 1px solid #eee; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; color: #555; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }

        /* --- RESULT SCREEN --- */
        #result-screen { padding: 20px; overflow-y: auto; text-align: center; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; border: 10px solid var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 30px auto; font-size: 36px; font-weight: bold; color: var(--primary); background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Toast Notification */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 30; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <div id="home-screen" class="screen active">
        <div class="app-logo">üèóÔ∏è</div>
        <h1 style="color: var(--primary); margin-top:0;">RCC Test (Q122-155)</h1>
        
        <div class="stats-card">
            <h3 style="margin-top:0; color: var(--primary);">Your Progress</h3>
            <div class="stats-row"><span>Last Score:</span> <span id="last-score" style="font-weight:bold;">-</span></div>
            <div class="stats-row"><span>Accuracy:</span> <span id="last-accuracy" style="font-weight:bold;">-</span></div>
            <div class="stats-row" style="border:none;"><span>Tests Taken:</span> <span id="test-count">0</span></div>
        </div>

        <button class="btn-large" onclick="initTest('all')">
            <span>‚ñ∂</span> START TEST
        </button>
        <button class="btn-large btn-secondary" onclick="initTest('bookmark')">
            <span>üîñ</span> REVISE BOOKMARKS
        </button>
        <div style="margin-top:30px; font-size:11px; color:#999;">Ver 5.0 (Q122-155 Only)</div>
    </div>

    <div id="quiz-screen" class="screen">
        <header>
            <div id="timer" class="timer">02:00:00</div>
            <div class="header-icons">
                <div class="header-icon" onclick="submitTest()" title="Submit Test">‚úì</div>
                <div class="header-icon" onclick="exitTest()" title="Exit Test">‚úï</div>
            </div>
        </header>

        <div id="quiz-container">
            </div>

        <footer>
            <button class="nav-btn" onclick="navStep(-1)">Prev</button>
            <div class="center-actions">
                <button class="icon-btn" id="btn-bookmark" onclick="toggleBookmark()">üîñ</button>
                <button class="icon-btn" id="btn-review" onclick="toggleReview()">üü£</button>
                <button class="icon-btn" onclick="togglePalette()">‚ñ¶</button>
            </div>
            <button class="nav-btn primary" onclick="navStep(1)">Next</button>
        </footer>

        <div id="palette-overlay" onclick="togglePalette()">
            <div id="palette" onclick="event.stopPropagation()">
                <div class="palette-header">
                    <span>Question Grid</span>
                    <span onclick="togglePalette()" style="cursor:pointer; font-size:24px;">&times;</span>
                </div>
                <div class="palette-grid" id="palette-grid"></div>
                <div class="legend">
                    <div class="legend-item"><div class="dot" style="background:var(--correct)"></div> Answered</div>
                    <div class="legend-item"><div class="dot" style="background:var(--review)"></div> Review</div>
                    <div class="legend-item"><div class="dot" style="background:var(--skipped)"></div> Skipped</div>
                    <div class="legend-item"><div class="dot" style="border:2px solid var(--blue-current); background:transparent"></div> Current</div>
                </div>
            </div>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <h2>Test Result</h2>
        <div class="score-circle">
            <span id="score-text">0</span>
            <span style="font-size:14px; color:#666; font-weight:normal; margin-top:5px;">Score</span>
        </div>
        <div class="stats-card" style="margin: 0 auto 20px;">
            <div class="stats-row"><span>Total Questions:</span> <span id="res-total">0</span></div>
            <div class="stats-row"><span>Attempted:</span> <span id="res-attempted">0</span></div>
            <div class="stats-row"><span>Correct:</span> <span id="res-correct" style="color:var(--correct); font-weight:bold;">0</span></div>
            <div class="stats-row"><span>Wrong:</span> <span id="res-wrong" style="color:var(--wrong); font-weight:bold;">0</span></div>
            <div class="stats-row" style="border:none;"><span>Accuracy:</span> <span id="res-accuracy" style="font-weight:bold;">0%</span></div>
        </div>
        <button class="btn-large" onclick="goHome()">Back to Home</button>
    </div>

    <div id="toast">Message</div>

<script>
/* --- DATA DATABASE (Questions 122-155) --- */
const allQuestionsDB = [
    { id: 122, text: "The minimum concrete cover for reinforcement under sea water should be", options: ["40 mm", "50 mm", "75 mm", "90 mm"], ans: 1, tag: "KPSC JE Code 137/2014", explanation: "For reinforcement concrete member subjected to sea water, the ACI code specifies that thickness of concrete cover should be at least 50 mm." },
    { id: 123, text: "The minimum cement content of concrete permanently under sea water should be:", options: ["2 kN/m¬≥", "5 kN/m¬≥", "6 kN/m¬≥", "3 kN/m¬≥"], ans: 3, tag: "KPSC JE Code 137/2014", explanation: "The minimum cement content for concrete permanently under sea water should be 3 kN/m¬≥ (approx 300 kg/m¬≥) and minimum cover over reinforcement should be 75 mm." },
    { id: 124, text: "Which of the following is the advantage of reinforced concrete?", options: ["Fire-resisting and durability", "Economy because of less maintenance cost", "Both (a) and (b)", "None of these"], ans: 2, tag: "KPCI JE 2012", explanation: "Advantages: Relatively high compressive strength, fire resistant, long service life + low maintenance cost." },
    { id: 125, text: "The shape of stress-strain curve of concrete prescribed by IS 456-1978 is:", options: ["Rectangular", "Parabolic", "Rectangular-Parabolic", "None of these"], ans: 2, tag: "KPSC JE Code 102/2014", explanation: "The shape of stress-strain curve if concrete is parabolic rectangular." },
    { id: 126, text: "Form works shall not released until the concrete has achieved a strength of", options: ["One-half the stress to which it may be subjected", "Equal to the stress to which it may be subjected", "Twice to the stress to which it may be subjected", "None of the above"], ans: 2, tag: "MIZORAM PSC JE 2015", explanation: "Forms shall not be released until the concrete has achieved a strength of at least twice the stress to which the concrete be subjected at the time of removal." },
    { id: 127, text: "As a general guidance, the maximum permissible free fall of concrete while placing may taken a", options: ["1.5 m", "2.0 m", "2.5 m", "2.8 m"], ans: 0, tag: "MIZORAM PSC JE 2015", explanation: "Sometimes specifies and inspectors dictate the maximum free-fall distance of concrete ... limit to 3 ft to 5 ft (0.9 to 1.5 m)." },
    { id: 128, text: "As per IS 456 recommendations, the thickness of footings edge on soils should not be less than", options: ["10 cm", "12 cm", "15 cm", "20 cm"], ans: 2, tag: "MIZORAM PSC JE 2015", explanation: "Depth of footing above bottom reinforcement shall not be less than 150 mm (15 cm) for footing on soil, nor less than 300 mm for footing on piles." },
    { id: 129, text: "To determine the modulus of rupture, the size of test specimen used is", options: ["150 √ó 150 √ó 500 mm", "100 √ó 100 √ó 700 mm", "150 √ó 150 √ó 700 mm", "100 √ó 100 √ó 500 mm"], ans: 2, tag: "MH PWD 2016", explanation: "To determine the modulus of rupture, the size of test specimen used is 150 √ó 150 √ó 700 mm." },
    { id: 130, text: "Unit weight of steel is ----- kg/m¬≥", options: ["7850", "8700", "4200", "6500"], ans: 0, tag: "Haryana SSC JE 13.04.2018", explanation: "Unit weight of steel is 7850 kg/m¬≥." },
    { id: 131, text: "The characteristics of HYSD bar are‚Äî", options: ["High yield strength and good bond", "More factor of safety", "Satisfactory bendability & weldability", "All of these"], ans: 3, tag: "MH PWD 2016", explanation: "The characteristics of HYSD bar are: High yield strength, good bond, factor of safety, satisfactory bendability and weldability." },
    { id: 132, text: "Approximate value of shrinkage strain in concrete, is", options: ["0.003", "0.0003", "0.00003", "0.03"], ans: 1, tag: "MH PWD 2016", explanation: "Approximate value of shrinkage strain in concrete is 0.0003." },
    { id: 133, text: "The Shrinkage in a concrete slab.", options: ["causes shear cracks", "causes tension cracks", "causes compression cracks", "does not cause any cracking"], ans: 1, tag: "MH PWD 2016", explanation: "The Shrinkage in a concrete slab causes tension cracks." },
    { id: 134, text: "While calculating the average of strength of three specimen to determine the test result of sample the individual variation should not be more than ------- percent of the average?", options: ["¬± 15", "¬± 20", "¬± 25", "¬± 30"], ans: 0, tag: "MH WCD 2019", explanation: "As per IS 456-2000... individual variation should not be more than ¬± 15% of average strength." },
    { id: 135, text: "For reinforced concrete of M20 grade, the minimum value of cement content (kg/m¬≥) & maximum value of free water cement ratio, respectively are", options: ["300 & 0.55", "300 & 0.5", "320 & 0.45", "340 & 0.45"], ans: 0, tag: "MH WCD 2019", explanation: "For M20 (Mild Exposure): Min Cement = 300 kg/m¬≥, Max w/c = 0.55." },
    { id: 136, text: "As per IS 456 : 2000, how many types of cement are allowed for intended use?", options: ["7", "8", "9", "10"], ans: 3, tag: "MH PWD 2019", explanation: "As per IS 456, approx 10 types of cement (like OPC 33/43/53, Rapid Hardening, PPC, Slag, etc.) are listed." },
    { id: 137, text: "As per IS 456 : 2000 assumptions, the standard deviation (N/sq-mm) value for M20 & M25 grade of concrete is", options: ["3.5", "4", "5", "6"], ans: 1, tag: "Nagar Parishad Mains 2018", explanation: "Standard Deviation (œÉ): M10/M15 = 3.5; M20/M25 = 4.0; M30 & above = 5.0." },
    { id: 138, text: "If the concrete is completely immersed in sea water, then it represents which one of the following environment exposure condition", options: ["Mild", "Moderate", "Severe", "Very Severe"], ans: 2, tag: "DDA 24.04.2018", explanation: "Concrete completely immersed in sea water -> Severe. (Coastal Area -> Moderate; Alternate Wet/Dry or Sea Spray -> Very Severe)." },
    { id: 139, text: "Which IS code uses the recommended guidelines for concrete mix design?", options: ["IS 12813", "IS 10262", "IS 800", "IS 1373"], ans: 1, tag: "SSC JE 2019", explanation: "Concrete Mix Design IS 10262 : 2009." },
    { id: 140, text: "The minimum cover, for RCC column should be:", options: ["25 mm", "50 mm", "30 mm", "40 mm"], ans: 3, tag: "SSC JE 2019", explanation: "Min cover for Column: 40 mm. (Slab: 20mm, Beam: 25mm, Footing: 50mm)." },
    { id: 141, text: "A load value obtained by multiplying the characteristic load with load factor is known as :", options: ["Design spectrum", "Dead load", "Fatigue load", "Designed load"], ans: 3, tag: "Haryana SSC JE 2018", explanation: "Design load (fd) = Characteristic load (f) √ó Partial safety factor." },
    { id: 142, text: "Standard deviation is proportional to", options: ["Minimum strength", "Design strength", "Mean strength", "Maximum strength"], ans: 2, tag: "SSC JE 2019", explanation: "Standard deviation = Constant... With constant coefficient of variation, standard deviation increases with strength... ratio of SD to mean is coeff of variation." },
    { id: 143, text: "According to IS 456 : 2000, what should be the nominal cover to reinforcement for footings?", options: ["45 mm", "20 mm", "50 mm", "30 mm"], ans: 2, tag: "SSC JE 23.09.2019", explanation: "Minimum cover for footings is 50 mm." },
    { id: 144, text: "According to IS 456 : 2000, what should be the unit weight of plain cement concrete?", options: ["24 kN/m¬≥", "23 kN/m¬≥", "21 kN/m¬≥", "22 kN/m¬≥"], ans: 0, tag: "SSC JE 23.09.2019", explanation: "PCC = 24 kN/m¬≥. RCC = 25 kN/m¬≥." },
    { id: 145, text: "Which one of the following gives the characteristic compressive strength compliance requirement for individual test result (in N/mm) of M20 grade or above?", options: ["fck - 3", "fck - 4", "fck - 5", "fck - 6"], ans: 0, tag: "MH PWD 2019", explanation: "Individual test result >= fck - 3 N/mm¬≤." },
    { id: 146, text: "In 4th amendment of IS 456-2000, M60 grade has been shifted", options: ["to standard concrete from high strength concrete", "to high strength concrete from high standard concrete", "to standard concrete", "None"], ans: 1, tag: "YCT", explanation: "M60 was standard, now it is part of High Strength Concrete (M60-M100)." },
    { id: 147, text: "In the standard concrete group of IS 456 : 2000, which one of the following is the maximum specified characteristic compressive strength of 150mm cube at 28 days?", options: ["20", "55", "80", "60"], ans: 1, tag: "MH PWD 2019", explanation: "Standard Concrete: M25 to M55. (Note: Amendment 4 changed this, but older questions often cite M55)." },
    { id: 148, text: "Which one of the following factors influences the creep of concrete?", options: ["Relative humidity", "Strength of the concrete", "Age of concrete at loading", "All the other options"], ans: 3, tag: "MH WCD 2019", explanation: "Creep depends on humidity, strength, age at loading, duration, etc." },
    { id: 149, text: "The effective length of a column in a RCC building frame as per IS:456-2000 is independent of the", options: ["frame type", "span of the beam", "height of column", "load acting on the frame"], ans: 3, tag: "MH Nanded Zila Parishad 2014", explanation: "Effective length depends on frame type, span, height, stiffness, but NOT directly on the load acting on the frame." },
    { id: 150, text: "A dead load is", options: ["One that does not exist", "One that is dead", "One that does not move", "One that remains constant"], ans: 3, tag: "MH Pimpri-Chinchwad MNC 2015", explanation: "A dead load is one that remains constant (structural weight)." },
    { id: 151, text: "The minimum yield stress for a Fe 415 is :", options: ["415 MPa", "395 MPa", "500 MPa", "550 MPa"], ans: 0, tag: "RRB SSE 2015", explanation: "For Fe 415, min yield stress is 415 MPa." },
    { id: 152, text: "The 28 days characteristic compressive strength of M25 grade concrete is", options: ["50 N/mm¬≤", "8 N/mm¬≤", "25 N/mm¬≤", "12.5 N/mm¬≤"], ans: 2, tag: "PGCIL DT 2021", explanation: "M25 means characteristic strength is 25 N/mm¬≤." },
    { id: 153, text: "The characteristic strength of a material is defined as", options: ["The value below which not more than 10% fail", "The value below which not more than 5% fail", "The value below which not more than 15% fail", "The value below which not more than 2.5% fail"], ans: 1, tag: "JKSSB JE 2013", explanation: "Characteristic strength: value below which not more than 5% of test results are expected to fall." },
    { id: 154, text: "For concrete of grade M50, the value of flexural tensile strength will be nearly", options: ["5 N/mm¬≤", "10 N/mm¬≤", "25 N/mm¬≤", "50 N/mm¬≤"], ans: 0, tag: "SSC JE 2018", explanation: "Flexural strength = 0.7‚àö50 = 4.95 ‚âà 5 N/mm¬≤." },
    { id: 155, text: "Permissible compressive strength of M 200 concrete grade is:", options: ["100 kg/cm¬≤", "150 kg/cm¬≤", "200 kg/cm¬≤", "250 kg/cm¬≤"], ans: 2, tag: "SSC JE 2009", explanation: "For M 200 (old grade, approx M20), strength is 200 kg/cm¬≤." }
];

/* --- STATE VARIABLES --- */
let activeQuestions = [];
let currentIndex = 0;
let userAnswers = {}; // { qId: optionIndex }
let reviewList = new Set();
let timerInterval;
let timeLeft;
let bookmarks = JSON.parse(localStorage.getItem('civilAppBookmarks_v5')) || [];
let history = JSON.parse(localStorage.getItem('civilAppHistory_v5')) || {score:0, total:0, accuracy:0, count:0};

/* --- INITIALIZATION --- */
window.onload = function() {
    updateHomeStats();
};

function updateHomeStats() {
    if(history.count > 0) {
        document.getElementById('last-score').innerText = `${history.score}/${history.total}`;
        document.getElementById('last-accuracy').innerText = `${history.accuracy}%`;
        document.getElementById('test-count').innerText = history.count;
    }
}

function showToast(msg) {
    const x = document.getElementById("toast");
    x.innerText = msg;
    x.className = "show";
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
}

/* --- CORE TEST FUNCTIONS --- */
function initTest(mode) {
    // 1. Determine Questions based on Mode
    if(mode === 'bookmark') {
        if(bookmarks.length === 0) {
            alert("No bookmarks saved yet! Go to Full Test and bookmark some questions.");
            return;
        }
        activeQuestions = allQuestionsDB.filter(q => bookmarks.includes(q.id));
    } else {
        activeQuestions = [...allQuestionsDB]; // Copy all
    }

    // 2. Reset State
    currentIndex = 0;
    userAnswers = {};
    reviewList.clear();
    timeLeft = (mode === 'bookmark') ? (activeQuestions.length * 90) : 7200; 

    // 3. Switch Screens
    document.querySelector('.active').classList.remove('active');
    document.getElementById('quiz-screen').classList.add('active');

    // 4. GENERATE PALETTE
    generatePalette();

    // 5. Render First Question & Start Timer
    renderQuestion();
    startTimer();
}

function generatePalette() {
    const grid = document.getElementById('palette-grid');
    grid.innerHTML = "";
    activeQuestions.forEach((q, idx) => {
        const item = document.createElement('div');
        item.className = 'p-item';
        item.innerText = idx + 1;
        item.id = `p-idx-${idx}`;
        item.onclick = () => {
            currentIndex = idx;
            renderQuestion();
            togglePalette();
        };
        grid.appendChild(item);
    });
}

function renderQuestion() {
    const q = activeQuestions[currentIndex];
    const container = document.getElementById('quiz-container');
    const isAnswered = userAnswers.hasOwnProperty(q.id);
    const selectedOpt = userAnswers[q.id];

    // Update Header Icons
    const isBookmarked = bookmarks.includes(q.id);
    const btnBook = document.getElementById('btn-bookmark');
    btnBook.innerText = isBookmarked ? "üè∑Ô∏è" : "üîñ";
    btnBook.classList.toggle('active-bookmark', isBookmarked);
    
    const isReview = reviewList.has(q.id);
    document.getElementById('btn-review').classList.toggle('active-review', isReview);

    let html = `
        <div class="question-card">
            <div class="q-meta">
                <span class="q-tag">${q.tag}</span>
                <span>Q.${currentIndex + 1} / ${activeQuestions.length}</span>
            </div>
            <div class="q-text">${q.text}</div>
            <ul class="options">
    `;

    q.options.forEach((opt, idx) => {
        let className = "option";
        
        if (isAnswered) {
            if (idx === q.ans) { className += " correct"; }
            else if (idx === selectedOpt) { className += " wrong"; }
            
            html += `<li class="${className}">
                <div class="option-circle">${idx===q.ans ? "‚úì" : (idx===selectedOpt ? "‚úï" : "")}</div>
                ${opt}
            </li>`;
        } else {
            html += `<li class="${className}" onclick="handleAnswer(${idx})">
                <div class="option-circle"></div>
                ${opt}
            </li>`;
        }
    });

    html += `</ul>`;

    if (isAnswered) {
        html += `
            <div class="solution-box" style="display:block">
                <div class="solution-header">üìã Solution Report</div>
                ${q.explanation}
            </div>
        `;
    }

    html += `</div>`;
    container.innerHTML = html;
    
    updatePaletteUI();
}

function updatePaletteUI() {
    activeQuestions.forEach((q, idx) => {
        const el = document.getElementById(`p-idx-${idx}`);
        if(!el) return;

        el.className = 'p-item'; // Reset
        if (currentIndex === idx) el.classList.add('current');
        
        if (userAnswers.hasOwnProperty(q.id)) {
            el.classList.add('answered');
        } else if (reviewList.has(q.id)) {
            el.classList.add('review');
        } else if (idx < currentIndex && !userAnswers.hasOwnProperty(q.id)) {
             el.classList.add('skipped');
        }
    });
}

function handleAnswer(optIdx) {
    const q = activeQuestions[currentIndex];
    userAnswers[q.id] = optIdx;
    renderQuestion(); 
}

function navStep(step) {
    const newIndex = currentIndex + step;
    if (newIndex >= 0 && newIndex < activeQuestions.length) {
        currentIndex = newIndex;
        renderQuestion();
    }
}

/* --- FEATURES --- */
function toggleBookmark() {
    const qId = activeQuestions[currentIndex].id;
    if(bookmarks.includes(qId)) {
        bookmarks = bookmarks.filter(id => id !== qId);
        showToast("Removed from Bookmarks");
    } else {
        bookmarks.push(qId);
        showToast("Added to Bookmarks");
    }
    localStorage.setItem('civilAppBookmarks_v5', JSON.stringify(bookmarks));
    renderQuestion();
}

function toggleReview() {
    const qId = activeQuestions[currentIndex].id;
    if (reviewList.has(qId)) {
        reviewList.delete(qId);
        showToast("Unmarked from Review");
    } else {
        reviewList.add(qId);
        showToast("Marked for Review");
    }
    renderQuestion();
    updatePaletteUI();
}

function togglePalette() {
    const overlay = document.getElementById('palette-overlay');
    const isVisible = overlay.style.display === 'flex';
    overlay.style.display = isVisible ? 'none' : 'flex';
}

function startTimer() {
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        timeLeft--;
        const hours = Math.floor(timeLeft / 3600).toString().padStart(2, '0');
        const mins = Math.floor((timeLeft % 3600) / 60).toString().padStart(2, '0');
        const secs = (timeLeft % 60).toString().padStart(2, '0');
        document.getElementById('timer').innerText = `${hours}:${mins}:${secs}`;
        if (timeLeft <= 0) submitTest();
    }, 1000);
}

function exitTest() {
    if(confirm("Exit Test? Progress will be lost.")) {
        goHome();
    }
}

function goHome() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('home-screen').classList.add('active');
    clearInterval(timerInterval);
    updateHomeStats();
}

function submitTest() {
    if(!confirm("Are you sure you want to submit?")) return;
    
    clearInterval(timerInterval);
    document.querySelector('.active').classList.remove('active');
    document.getElementById('result-screen').classList.add('active');

    let correct = 0;
    let wrong = 0;
    
    activeQuestions.forEach(q => {
        if(userAnswers.hasOwnProperty(q.id)) {
            if(userAnswers[q.id] === q.ans) correct++;
            else wrong++;
        }
    });

    const attempted = Object.keys(userAnswers).length;
    const accuracy = attempted > 0 ? Math.round((correct / attempted) * 100) : 0;
    const total = activeQuestions.length;

    document.getElementById('score-text').innerText = correct;
    document.getElementById('res-total').innerText = total;
    document.getElementById('res-attempted').innerText = attempted;
    document.getElementById('res-correct').innerText = correct;
    document.getElementById('res-wrong').innerText = wrong;
    document.getElementById('res-accuracy').innerText = accuracy + "%";

    // Update Global History 
    history = { 
        score: correct, 
        total: total, 
        accuracy: accuracy, 
        count: (history.count || 0) + 1 
    };
    localStorage.setItem('civilAppHistory_v5', JSON.stringify(history));
}
</script>
</body>
</html>
